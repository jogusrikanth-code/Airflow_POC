apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-api-server
  namespace: airflow
spec:
  template:
    spec:
      initContainers:
      - name: install-providers
        image: apache/airflow:3.0.2-python3.11
        command: ["/bin/bash", "/scripts/install-providers.sh"]
        volumeMounts:
        - name: provider-scripts
          mountPath: /scripts
        - name: airflow-providers
          mountPath: /home/airflow/.local
      volumes:
      - name: provider-scripts
        configMap:
          name: airflow-provider-init
          defaultMode: 0755
      - name: airflow-providers
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-scheduler
  namespace: airflow
spec:
  template:
    spec:
      initContainers:
      - name: install-providers
        image: apache/airflow:3.0.2-python3.11
        command: ["/bin/bash", "/scripts/install-providers.sh"]
        volumeMounts:
        - name: provider-scripts
          mountPath: /scripts
        - name: airflow-providers
          mountPath: /home/airflow/.local
      volumes:
      - name: provider-scripts
        configMap:
          name: airflow-provider-init
          defaultMode: 0755
      - name: airflow-providers
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-dag-processor
  namespace: airflow
spec:
  template:
    spec:
      initContainers:
      - name: install-providers
        image: apache/airflow:3.0.2-python3.11
        command: ["/bin/bash", "/scripts/install-providers.sh"]
        volumeMounts:
        - name: provider-scripts
          mountPath: /scripts
        - name: airflow-providers
          mountPath: /home/airflow/.local
      volumes:
      - name: provider-scripts
        configMap:
          name: airflow-provider-init
          defaultMode: 0755
      - name: airflow-providers
        emptyDir: {}
