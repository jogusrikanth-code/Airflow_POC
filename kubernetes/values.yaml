# Airflow Helm Chart Values for Azure Kubernetes Service (AKS)
# Reference: https://airflow.apache.org/docs/helm-chart/stable/index.html
# Deploy to AKS with: helm install airflow apache-airflow/airflow -n airflow --create-namespace -f kubernetes/values.yaml

# Namespace
namespace: airflow

# Database configuration (external PostgreSQL)
data:
  metadataConnection:
    user: airflow
    pass: airflow
    protocol: postgresql
    host: postgres
    port: 5432
    db: airflow
    sslmode: disable
  # Use the same database for result backend
  resultBackendConnection:
    user: airflow
    pass: airflow
    protocol: postgresql
    host: postgres
    port: 5432
    db: airflow
    sslmode: disable

# Airflow Version - Using latest Airflow 3.0.2
airflowVersion: "3.0.2"
defaultAirflowRepository: apache/airflow
defaultAirflowTag: "3.0.2-python3.11"

# Extra pip packages to install on all pods
# These will be automatically installed during pod startup
extraPipPackages:
  # Azure Integration - Latest versions
  - "apache-airflow-providers-microsoft-azure>=10.5.0"
  - "azure-storage-blob>=12.23.0"
  - "azure-identity>=1.19.0"
  - "azure-mgmt-resource>=23.2.0"
  
  # Databricks Integration - Latest
  - "apache-airflow-providers-databricks>=6.11.0"
  - "databricks-sql-connector>=3.6.0"
  
  # PowerBI & SQL Server Integration
  - "apache-airflow-providers-microsoft-mssql>=3.8.0"
  - "pyodbc>=5.2.0"
  - "apache-airflow-providers-odbc>=4.9.0"
  
  # Other essential providers
  - "apache-airflow-providers-postgres>=5.14.0"
  - "apache-airflow-providers-http>=4.13.0"
  - "apache-airflow-providers-common-sql>=1.19.0"
  
  # Data processing libraries
  - "pandas>=2.2.0"
  - "openpyxl>=3.1.0"
  - "requests>=2.32.0"
  - "sqlalchemy>=2.0.0"

# PostgreSQL Configuration
postgresql:
  enabled: false  # Using external PostgreSQL

# Redis Configuration
redis:
  enabled: true
  persistence:
    enabled: false

# Executor Configuration
executor: CeleryExecutor

# Airflow Core Configuration
config:
  core:
    dags_folder: /opt/airflow/dags
    executor: CeleryExecutor
    max_active_runs_per_dag: 1
    parallelism: 4
    dag_concurrency: 2
    max_active_tasks_per_dag: 16
    fernet_key: d60qlHqPR3w-jNiCIe_3T9LvQd1VZ1UqU1p-jEiMCFA=
    log_level: INFO
  celery:
    worker_concurrency: 2
  database:
    sql_alchemy_conn_secret: airflow-secrets
    sql_alchemy_conn_secret_key: sql_alchemy_conn

# Webserver Configuration
webserver:
  replicas: 1
  service:
    type: LoadBalancer
    ports:
      - name: airflow-ui
        port: 8080
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"

# Scheduler Configuration
scheduler:
  replicas: 1
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"

# Worker Configuration
workers:
  replicas: 1
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1024Mi"

# DAG Configuration
dags:
  persistence:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteMany
    storageClassName: azurefile-csi

# Logs Configuration
logs:
  persistence:
    enabled: false
  # Use emptyDir for logs to avoid PVC provisioning issues
  emptyDirConfig:
    sizeLimit: 10Gi

# Security Context
securityContext:
  runAsUser: 50000
  fsGroup: 0

# RBAC
rbac:
  create: true

# Service Account
serviceAccount:
  create: true
  name: airflow

# Resource Quotas
resources:
  requests:
    cpu: "1"
    memory: "2Gi"
  limits:
    cpu: "2"
    memory: "4Gi"
