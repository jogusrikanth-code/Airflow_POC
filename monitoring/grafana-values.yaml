# Grafana Configuration for Airflow Monitoring
# Deploys Grafana with Azure Monitor / Log Analytics integration

# Admin credentials
adminUser: admin
adminPassword: admin123

# Service configuration - expose via LoadBalancer
service:
  type: LoadBalancer
  port: 80
  targetPort: 3000

# Datasources - Connect to Azure Monitor
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # Prometheus (from Airflow StatsD exporter)
      - name: Airflow-Prometheus
        type: prometheus
        url: http://airflow-statsd.airflow.svc.cluster.local:9102
        access: proxy
        isDefault: true
        editable: true
      
      # Azure Monitor Logs (Log Analytics)
      - name: Azure-Monitor-Logs
        type: grafana-azure-monitor-datasource
        access: proxy
        jsonData:
          azureAuthType: msi
          subscriptionId: 12f4f875-7d27-4234-889e-249988508376
          cloudName: azuremonitor
          azureLogAnalyticsSameAs: true
          logAnalyticsSubscriptionId: 12f4f875-7d27-4234-889e-249988508376
          logAnalyticsDefaultWorkspace: /subscriptions/12f4f875-7d27-4234-889e-249988508376/resourceGroups/bi_lakehouse_dev_rg/providers/Microsoft.OperationalInsights/workspaces/airflow-logs-workspace

# Dashboards
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-load Airflow dashboard
dashboards:
  default:
    airflow:
      gnetId: 15440  # Official Airflow Grafana dashboard
      revision: 1
      datasource: Airflow-Prometheus

# Plugins
plugins:
  - grafana-azure-monitor-datasource
  - grafana-piechart-panel
  - grafana-clock-panel

# Resources
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Persistence (optional)
persistence:
  enabled: true
  size: 10Gi
  storageClassName: default

# Enable anonymous access for demos (disable in production)
grafana.ini:
  auth.anonymous:
    enabled: false
  server:
    root_url: "%(protocol)s://%(domain)s:%(http_port)s/"
    serve_from_sub_path: false
  analytics:
    reporting_enabled: false
    check_for_updates: false
