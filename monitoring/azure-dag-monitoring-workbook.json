{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Airflow DAG Monitoring Dashboard\n### Centralized monitoring for all DAG executions\n---\n**Cluster:** aks-airflow-poc | **Namespace:** airflow | **Refresh:** Auto (5 min)"
      },
      "name": "text - title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "time-range",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            },
            "label": "Time Range"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - time"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where ContainerName contains \"scheduler\" or ContainerName contains \"dag-processor\"\n| where LogEntry contains \"DAG\" or LogEntry contains \"Task\"\n| where TimeGenerated {TimeRange:value}\n| summarize \n    TotalExecutions = countif(LogEntry contains \"Running\" or LogEntry contains \"Executing\"),\n    SuccessCount = countif(LogEntry contains \"success\" or LogEntry contains \"completed\"),\n    FailureCount = countif(LogEntry contains \"failed\" or LogEntry contains \"error\"),\n    QueuedCount = countif(LogEntry contains \"queued\")\n| extend SuccessRate = round(todouble(SuccessCount) / todouble(TotalExecutions) * 100, 2)\n| project TotalExecutions, SuccessCount, FailureCount, QueuedCount, SuccessRate",
        "size": 4,
        "title": "DAG Execution Overview",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Column",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Value",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            }
          },
          "showBorder": true
        }
      },
      "customWidth": "100",
      "name": "query - overview tiles"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where LogEntry contains \"DAG\" or LogEntry contains \"Task\"\n| where TimeGenerated {TimeRange:value}\n| extend Status = case(\n    LogEntry contains \"success\" or LogEntry contains \"completed\", \"Success\",\n    LogEntry contains \"failed\" or LogEntry contains \"error\", \"Failed\",\n    LogEntry contains \"running\" or LogEntry contains \"executing\", \"Running\",\n    LogEntry contains \"queued\", \"Queued\",\n    \"Other\"\n)\n| where Status in (\"Success\", \"Failed\", \"Running\", \"Queued\")\n| summarize Count = count() by Status\n| render piechart",
        "size": 0,
        "title": "DAG Runs by Status",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart"
      },
      "customWidth": "50",
      "name": "query - status pie"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where LogEntry contains \"DAG\" or LogEntry contains \"Task\"\n| where TimeGenerated {TimeRange:value}\n| extend Status = case(\n    LogEntry contains \"success\" or LogEntry contains \"completed\", \"Success\",\n    LogEntry contains \"failed\" or LogEntry contains \"error\", \"Failed\",\n    LogEntry contains \"running\", \"Running\",\n    \"Other\"\n)\n| where Status in (\"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
        "size": 0,
        "title": "DAG Execution Trend (Success vs Failed)",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "timechart"
      },
      "customWidth": "50",
      "name": "query - trend chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where LogEntry contains \"failed\" or LogEntry contains \"error\" or LogEntry contains \"ERROR\"\n| where LogEntry contains \"DAG\" or LogEntry contains \"Task\"\n| where TimeGenerated {TimeRange:value}\n| extend DAGName = extract(@\"dag_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| extend TaskName = extract(@\"task_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| project TimeGenerated, DAGName, TaskName, LogEntry\n| order by TimeGenerated desc\n| take 50",
        "size": 0,
        "title": "Recent Failed DAG Runs (Last 50)",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "TimeGenerated",
              "formatter": 5
            },
            {
              "columnMatch": "DAGName",
              "formatter": 1
            },
            {
              "columnMatch": "TaskName",
              "formatter": 1
            },
            {
              "columnMatch": "LogEntry",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "CellDetails"
              }
            }
          ],
          "filter": true
        }
      },
      "customWidth": "100",
      "name": "query - failed runs"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where LogEntry contains \"DAG\" or LogEntry contains \"Task\"\n| where TimeGenerated {TimeRange:value}\n| extend DAGName = extract(@\"dag_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| where isnotempty(DAGName)\n| summarize \n    TotalRuns = count(),\n    SuccessRuns = countif(LogEntry contains \"success\" or LogEntry contains \"completed\"),\n    FailedRuns = countif(LogEntry contains \"failed\" or LogEntry contains \"error\")\n    by DAGName\n| extend SuccessRate = round(todouble(SuccessRuns) / todouble(TotalRuns) * 100, 2)\n| order by FailedRuns desc\n| take 20",
        "size": 0,
        "title": "Top DAGs by Execution Count",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "DAGName",
              "formatter": 1
            },
            {
              "columnMatch": "SuccessRate",
              "formatter": 8,
              "formatOptions": {
                "palette": "greenRed"
              }
            }
          ],
          "filter": true,
          "sortBy": [
            {
              "itemKey": "TotalRuns",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "TotalRuns",
            "sortOrder": 2
          }
        ]
      },
      "customWidth": "50",
      "name": "query - dag stats"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where ContainerName contains \"scheduler\"\n| where LogEntry contains \"duration\" or LogEntry contains \"took\"\n| where TimeGenerated {TimeRange:value}\n| extend DurationSeconds = extract(@\"(\\d+\\.?\\d*)\\s*seconds?\", 1, LogEntry)\n| where isnotempty(DurationSeconds)\n| extend Duration = todouble(DurationSeconds)\n| extend DAGName = extract(@\"dag_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| where isnotempty(DAGName)\n| summarize \n    AvgDuration = round(avg(Duration), 2),\n    MaxDuration = round(max(Duration), 2),\n    MinDuration = round(min(Duration), 2),\n    ExecutionCount = count()\n    by DAGName\n| order by AvgDuration desc\n| take 15",
        "size": 0,
        "title": "DAG Execution Duration (Average, Max, Min)",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "AvgDuration",
              "formatter": 8,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "MaxDuration",
              "formatter": 8,
              "formatOptions": {
                "palette": "red"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "query - duration stats"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where LogEntry contains \"retry\" or LogEntry contains \"attempt\"\n| where TimeGenerated {TimeRange:value}\n| extend DAGName = extract(@\"dag_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| extend TaskName = extract(@\"task_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| where isnotempty(DAGName)\n| summarize RetryCount = count() by DAGName, TaskName\n| order by RetryCount desc\n| take 20",
        "size": 0,
        "title": "Tasks with Most Retries",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "RetryCount",
              "formatter": 8,
              "formatOptions": {
                "palette": "orange"
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "query - retries"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let PodCPU = Perf\n| where ObjectName == \"K8SContainer\"\n| where CounterName == \"cpuUsageNanoCores\"\n| where InstanceName contains \"airflow\"\n| where TimeGenerated {TimeRange:value}\n| summarize AvgCPU = avg(CounterValue) / 1000000000 by bin(TimeGenerated, 5m), InstanceName;\nlet PodMemory = Perf\n| where ObjectName == \"K8SContainer\"\n| where CounterName == \"memoryRssBytes\"\n| where InstanceName contains \"airflow\"\n| where TimeGenerated {TimeRange:value}\n| summarize AvgMemoryMB = avg(CounterValue) / 1048576 by bin(TimeGenerated, 5m), InstanceName;\nPodCPU\n| join kind=inner (PodMemory) on TimeGenerated, InstanceName\n| project TimeGenerated, InstanceName, AvgCPU, AvgMemoryMB\n| render timechart",
        "size": 0,
        "title": "Airflow Pod Resource Usage (CPU & Memory)",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "timechart"
      },
      "customWidth": "50",
      "name": "query - resources"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "ContainerLog\n| where Namespace == \"airflow\"\n| where TimeGenerated {TimeRange:value}\n| extend DAGName = extract(@\"dag_id[=:]\\s*([\\w_-]+)\", 1, LogEntry)\n| where isnotempty(DAGName)\n| summarize Count = count() by DAGName\n| order by Count desc\n| take 10\n| render barchart",
        "size": 0,
        "title": "Top 10 Most Active DAGs",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart"
      },
      "customWidth": "100",
      "name": "query - active dags"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/12f4f875-7d27-4234-889e-249988508376/resourceGroups/bi_lakehouse_dev_rg/providers/Microsoft.OperationalInsights/workspaces/airflow-logs-workspace"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
